



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Mirror Maker 2.0 - Apache Kafka Studies</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#mirror-maker-20" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Apache Kafka Studies" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Apache Kafka Studies
            </span>
            <span class="md-header-nav__topic">
              Mirror Maker 2.0
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/jbcodeforce/kafka-studies.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Apache Kafka Studies" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Apache Kafka Studies
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/jbcodeforce/kafka-studies.git/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/readme" title="Apache Kafka summary" class="md-nav__link">
      Apache Kafka summary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/consumers" title="Consumer practices" class="md-nav__link">
      Consumer practices
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/producers" title="Producer practices" class="md-nav__link">
      Producer practices
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kstreams/" title="Kafka streaming notes" class="md-nav__link">
      Kafka streaming notes
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Mirror Maker 2.0
      </label>
    
    <a href="./" title="Mirror Maker 2.0" class="md-nav__link md-nav__link--active">
      Mirror Maker 2.0
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general-concepts" title="General concepts" class="md-nav__link">
    General concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-event-streams-to-local-cluster" title="From Event Streams to local cluster" class="md-nav__link">
    From Event Streams to local cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-kafka-local-as-source-to-event-streams-on-cloud-as-target" title="From Kafka local as source to Event Streams on Cloud as Target" class="md-nav__link">
    From Kafka local as source to Event Streams on Cloud as Target
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-event-streams-on-cloud-to-strimzi-cluster-on-openshift" title="From Event Streams On Cloud to Strimzi Cluster on Openshift" class="md-nav__link">
    From Event Streams On Cloud to Strimzi Cluster on Openshift
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-kafka-cluster-on-openshift-cluster-to-local-cluster" title="From Kafka cluster on Openshift cluster to local cluster" class="md-nav__link">
    From Kafka cluster on Openshift cluster to local cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typical-errors-in-mirror-maker-2-traces" title="Typical errors in Mirror Maker 2 traces" class="md-nav__link">
    Typical errors in Mirror Maker 2 traces
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/FAQ" title="Kafka FAQ" class="md-nav__link">
      Kafka FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/connect" title="Kafka Connect" class="md-nav__link">
      Kafka Connect
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#general-concepts" title="General concepts" class="md-nav__link">
    General concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-event-streams-to-local-cluster" title="From Event Streams to local cluster" class="md-nav__link">
    From Event Streams to local cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-kafka-local-as-source-to-event-streams-on-cloud-as-target" title="From Kafka local as source to Event Streams on Cloud as Target" class="md-nav__link">
    From Kafka local as source to Event Streams on Cloud as Target
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-event-streams-on-cloud-to-strimzi-cluster-on-openshift" title="From Event Streams On Cloud to Strimzi Cluster on Openshift" class="md-nav__link">
    From Event Streams On Cloud to Strimzi Cluster on Openshift
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from-kafka-cluster-on-openshift-cluster-to-local-cluster" title="From Kafka cluster on Openshift cluster to local cluster" class="md-nav__link">
    From Kafka cluster on Openshift cluster to local cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typical-errors-in-mirror-maker-2-traces" title="Typical errors in Mirror Maker 2 traces" class="md-nav__link">
    Typical errors in Mirror Maker 2 traces
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jbcodeforce/kafka-studies.git/edit/master/docs/mirrormaker.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="mirror-maker-20">Mirror Maker 2.0</h1>
<p>Mirror Maker 2.0 is the new replication feature of Kafka 2.4.</p>
<p>The <code>mirror-maker-2</code> folder includes, scripts, code and configurations to support the different topic replication scenarios we want to validate:</p>
<ul>
<li>Replicate from Event Streams on cloud being source cluster to local Kafka cluster running on local machine (started via docker-compose) using Strimzi Kafka docker image.</li>
<li>Replicate from <a href="https://strimzi.io/">Strimzi</a> Kafka cluster running on OpenShift to Event Streams on Cloud. (See detail <a href="#from-strimzi-local-as-source-to-event-streams-on-cloud-as-target">in this section</a>)</li>
</ul>
<h2 id="general-concepts">General concepts</h2>
<p>As <a href="https://strimzi.io/docs/master/#con-configuring-mirror-maker-deployment-configuration-kafka-mirror-maker">Mirror maker 2.0</a> is using kafka Connect framework, so we recommend to review our summary <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/connect/">in this note</a>.</p>
<p>The figure below illustrates the mirror maker internal components running in Kafka Connect.</p>
<p><img alt="" src="../images/mm-k-connect.png" /></p>
<p>As Mirror maker is running Kafka Connect in distributed mode, it creates the following topics on the the target cluster:</p>
<ul>
<li>mm2-configs.source.internal: This topic will store the connector and task configurations.</li>
<li>mm2-offsets.source.internal: This topic is used to store offsets for Kafka Connect.</li>
<li>
<p>mm2-status.source.internal: This topic will store status updates of connectors and tasks.</p>
</li>
<li>
<p>White listed topics is set with the <code>.topics</code> attribute and use Java regular expression syntax. </p>
</li>
<li>Blacklisted topics: by default the following pattern is applied 
<div class="codehilite"><pre><span></span>blacklist = [follower\.replication\.throttled\.replicas, leader\.replication\.throttled\.replicas, message\.timestamp\.difference\.max\.ms, message\.timestamp\.type, unclean\.leader\.election\.enable, min\.insync\.replicas]
</pre></div></li>
</ul>
<p>Internally <code>MirrorSourceConnector</code> and <code>MirrorCheckpointConnector</code> will
create multiple tasks (up to tasks.max), <code>MirrorHeartbeatConnector</code>
creates only one single task. <code>MirrorSourceConnector</code> will have one task per topic-partition to replicate, while <code>MirrorCheckpointConnector</code> will have one task per consumer group. The Kafka connect framework uses the coordinator API, with assign API and so there is no consumer group while fetching data from source topic. There is no call to commit() neither: the rebalancing occurs only when there is a new topic created that matches the whitelist pattern.</p>
<h2 id="from-event-streams-to-local-cluster">From Event Streams to local cluster</h2>
<p>For the second tests the source is Event Streams on IBM Cloud:</p>
<p><img alt="" src="../images/mm2-test2.png" /></p>
<p>This time the producer adds headers and message and Mirror maker need to get the APIkey, so the mirror-maker.properties looks like:</p>
<div class="codehilite"><pre><span></span><span class="na">clusters</span><span class="o">=</span><span class="s">source, target</span>
<span class="na">source.bootstrap.servers</span><span class="o">=</span><span class="s">broker-3-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-1-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-0-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-5-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-2-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4-qnprtqnp7hnkssdz.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093</span>
<span class="na">source.security.protocol</span><span class="o">=</span><span class="s">SASL_SSL</span>
<span class="na">source.ssl.protocol</span><span class="o">=</span><span class="s">TLSv1.2</span>
<span class="na">source.sasl.mechanism</span><span class="o">=</span><span class="s">PLAIN</span>
<span class="na">source.sasl.jaas.config</span><span class="o">=</span><span class="s">org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;token&quot; password=&quot;985...&quot;;</span>
<span class="na">target.bootstrap.servers</span><span class="o">=</span><span class="s">kafka1:9092,kafka2:9093,kafka3:9094</span>
<span class="c"># enable and configure individual replication flows</span>
<span class="na">source-&gt;target.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">source-&gt;target.topics</span><span class="o">=</span><span class="s">orders</span>
</pre></div>

<h2 id="from-kafka-local-as-source-to-event-streams-on-cloud-as-target">From Kafka local as source to Event Streams on Cloud as Target</h2>
<p>We have created an Event Streams cluster on Washington DC data center. We have a Strimzi Kafka cluster defined in Washington data center in a OpenShift Cluster. As both clusters are in the same data center, we deploy Mirror Maker 2.0 close to target cluster (Event Streams on Cloud).</p>
<p><img alt="" src="../images/mm2-local-to-es.png" /></p>
<p>What needs to be done:</p>
<ul>
<li>Get Broker list and API Key for Event Streams service on cloud using the service credentials.</li>
<li>Get a Openshift cluster in the same data center as Event Streams service.</li>
<li>Create a project in OpenShift: MirrorMakerToES.</li>
<li>Deploy Kafka cluster and topic Strimzi operators. See the note here to do so</li>
<li>Define source and target cluster properties in mirror maker properties file </li>
</ul>
<div class="codehilite"><pre><span></span>
</pre></div>

<ul>
<li>Add this properties file as a ConfigMap in OpenShift</li>
</ul>
<div class="codehilite"><pre><span></span>oc create configmap mm2properties --from-file kafka-to-es-mm2.properties 
</pre></div>

<p>The filename becomes a key stored in the data section of the ConfigMap.</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">kafka-to-es-mm2.properties</span><span class="p">:</span>
</pre></div>

<ul>
<li>Deploy Mirror maker 2.0 pod within this project</li>
</ul>
<div class="codehilite"><pre><span></span>oc apply -f mm2-pod.yaml 
</pre></div>

<ul>
<li>Define a secret for the API key of the target cluster
<code>oc create secret generic es-apikey-target --from-literal=binding=am_</code></li>
<li>Start a producer (for example the below code send products reference data into products topic)</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">KAFKA_PWD</span><span class="o">=</span><span class="s2">&quot;replace-with-event-streams-apikey&quot;</span>
<span class="nb">export</span> <span class="nv">KAFKA_BROKERS</span><span class="o">=</span><span class="s2">&quot;...&quot;</span>
docker run -ti -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home --rm -e <span class="nv">KAFKA_PWD</span><span class="o">=</span><span class="nv">$KAFKA_PWD</span> -e <span class="nv">KAFKA_BROKERS</span><span class="o">=</span><span class="nv">$KAFKA_BROKERS</span> jbcodeforce/python37   bash
python SendProductToKafka.py
</pre></div>

<ul>
<li>Define a source cluster properties file with truststore and bootstrap servers. This file is used for the different Kafka tools like kafka-topics.sh or console producer and consumer.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="na">bootstrap.servers</span><span class="o">=</span><span class="s">....</span>
<span class="na">security.protocol</span><span class="o">=</span><span class="s">SSL</span>
<span class="na">ssl.truststore.password</span><span class="o">=</span><span class="s">password</span>
<span class="na">ssl.truststore.location</span><span class="o">=</span><span class="s">/home/truststore.jks</span>
</pre></div>

<p>and a target cluster property file:</p>
<div class="codehilite"><pre><span></span><span class="na">bootstrap.servers</span><span class="o">=</span><span class="s">broker-3-q.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093,broker-4-q.kafka.svc01.us-east.eventstreams.cloud.ibm.com:9093</span>
<span class="na">security.protocol</span><span class="o">=</span><span class="s">SASL_SSL</span>
<span class="na">ssl.protocol</span><span class="o">=</span><span class="s">TLSv1.2</span>
<span class="na">sasl.mechanism</span><span class="o">=</span><span class="s">PLAIN</span>
<span class="na">sasl.jaas.config</span><span class="o">=</span><span class="s">org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;token&quot; password=&quot;am_...&quot;;</span>
</pre></div>

<ul>
<li>
<p>Start a product producer with a python client code</p>
</li>
<li>
<p>Start a consumer locally on your compute using the Strimzi/kafka image.</p>
</li>
</ul>
<div class="codehilite"><pre><span></span>docker run -ti -v $(pwd):/home strimzi/kafka:latest-kafka-2.4.0 bash
cd /opt/kafka/bin
./kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap-jb-kafka-strimzi.gse-eda-demos-fa9ee67c9ab6a7791435450358e564cc-0001.us-east.containers.appdomain.cloud:443 --consumer.config /home/strimzi.properties  --topic products
</pre></div>

<ul>
<li>Verify the created topics on target cluster (Event Streams)
<div class="codehilite"><pre><span></span>/opt/kafka/bin/kafka-topics.sh --bootstrap-server $KAFKA_BROKERS --command-config /home/eventstream.properties --list
</pre></div></li>
<li>In case you need it... looking at source cluster topic list:</li>
</ul>
<div class="codehilite"><pre><span></span>/opt/kafka/bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap-jb-kafka-strimzi.gse-eda-demos-fa9ee67c9ab6a7791435450358e564cc-0001.us-east.containers.appdomain.cloud:443 --command-config /home/strinzi.properties --list 
</pre></div>

<p>Get detail on one topic:</p>
<div class="codehilite"><pre><span></span>/opt/kafka/bin//kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap-jb-kafka-strimzi.gse-eda-demos-fa9ee67c9ab6a7791435450358e564cc-0001.us-east.containers.appdomain.cloud:443  --command-config /home/strimzi.properties --describe --topic products
</pre></div>

<h2 id="from-event-streams-on-cloud-to-strimzi-cluster-on-openshift">From Event Streams On Cloud to Strimzi Cluster on Openshift</h2>
<h2 id="from-kafka-cluster-on-openshift-cluster-to-local-cluster">From Kafka cluster on Openshift cluster to local cluster</h2>
<p><img alt="" src="../images/mm2-test1.png" /></p>
<p>The source cluster is a Strimzi cluster running on Openshift as a service on IBM Cloud. It was installed following the instructions <a href="https://ibm-cloud-architecture.github.io/refarch-eda/deployments/strimzi/deploy/">documented here</a>.</p>
<p>The target cluster is also based on Strimzi kafka 2.4 docker image, but run in a local host, with docker compose. It starts two zookeeper nodes, and three kafka nodes. We need 3 kafka brokers as mirror maker created topics with a replication factor set to 3.</p>
<ul>
<li>
<p>Start the target cluster runnning on your laptop using:</p>
<div class="codehilite"><pre><span></span>docker-compose up
</pre></div>

</li>
<li>
<p>Start <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-382%3A+MirrorMaker+2.0">mirror maker2.0</a>: </p>
<p>By using a new container, start another kakfa 2.4+ docker container, connected to the  brokers via the <code>kafkanet</code> network, and mounting the configuration in the <code>/home</code>:</p>
<div class="codehilite"><pre><span></span>docker run -ti --network kafkanet -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home strimzi/kafka:latest-kafka-2.4.0 bash
</pre></div>

<p>Inside this container starts mirror maker 2.0 using the script: <code>/opt/kakfa/bin/connect-mirror-maker.sh</code></p>
<div class="codehilite"><pre><span></span>/opt/kakfa/bin/connect-mirror-maker.sh /home/strimzi-mm2.properties
</pre></div>

<p>The <code>strimzi-mm2.properties</code> properties file given as argument defines the source and target clusters and the topics to replicate:</p>
<div class="codehilite"><pre><span></span><span class="na">clusters</span><span class="o">=</span><span class="s">source, target</span>
<span class="na">source.bootstrap.servers</span><span class="o">=</span><span class="s">my-cluster-kafka-bootstrap-jb-kafka-strimzi.gse-eda-demos-fa9ee67c9ab6a7791435450358e564cc-0001.us-east.containers.appdomain.cloud:443</span>
<span class="na">source.security.protocol</span><span class="o">=</span><span class="s">SSL</span>
<span class="na">source.ssl.truststore.password</span><span class="o">=</span><span class="s">password</span>
<span class="na">source.ssl.truststore.location</span><span class="o">=</span><span class="s">/home/truststore.jks</span>
<span class="na">target.bootstrap.servers</span><span class="o">=</span><span class="s">kafka1:9092,kafka2:9093,kafka3:9094</span>
<span class="c"># enable and configure individual replication flows</span>
<span class="na">source-&gt;target.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">source-&gt;target.topics</span><span class="o">=</span><span class="s">orders</span>
</pre></div>

<p>As the source cluster is deployed on Openshift, the exposed route to access the brokers is using TLS connection. So we need the certificate and create a truststore to be used by those Java programs. All kafka tools are done in java or scala so running in a JVM, which needs truststore for keep trusted TLS certificates. 
When running from a remote system to get the certificate do the following steps:</p>
<ol>
<li>
<p>Get the host ip address from the Route resource</p>
<div class="codehilite"><pre><span></span>oc get routes my-cluster-kafka-bootstrap -o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.ingress[0].host}{&quot;\n&quot;}&#39;</span>
</pre></div>

</li>
<li>
<p>Get the TLS certificate from the broker</p>
<div class="codehilite"><pre><span></span>oc get secrets
oc extract secret/my-cluster-cluster-ca-cert --keys<span class="o">=</span>ca.crt --to<span class="o">=</span>- &gt; ca.crt
</pre></div>

</li>
<li>
<p>Transform the certificate fo java truststore</p>
<div class="codehilite"><pre><span></span>keytool -import -trustcacerts -alias root -file ca.crt -keystore truststore.jks -storepass password -noprompt
</pre></div>

</li>
</ol>
<p>For Openshift or Kubernetes deployment, the mirror maker descriptor needs to declare the TLS stamza:</p>
<div class="codehilite"><pre><span></span><span class="nt">mirrors</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">sourceCluster</span><span class="p">:</span> <span class="s">&quot;my-cluster-source&quot;</span>
<span class="nt">targetCluster</span><span class="p">:</span> <span class="s">&quot;my-cluster-target&quot;</span>
<span class="nt">sourceConnector</span><span class="p">:</span>
  <span class="nt">config</span><span class="p">:</span>
    <span class="nt">replication.factor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">offset-syncs.topic.replication.factor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">sync.topic.acls.enabled</span><span class="p">:</span> <span class="s">&quot;false&quot;</span>
<span class="nt">targetConnector</span><span class="p">:</span>
  <span class="nt">tls</span><span class="p">:</span>
    <span class="nt">trustedCertificates</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">secretName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-cluster-cluster-cert</span>
        <span class="nt">certificate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
</pre></div>

</li>
<li>
<p>The consumer may be started in second or third step. To start it, you can use a new container or use one of the running kafka broker container. Using the <code>Docker perspective</code> in Visual Code, we can get into a bash shell within one of the Kafka broker container. The local folder is mounted to <code>/home</code>. Then the script, <code>consumeFromLocal.sh source.orders</code> will get messages from the replicated topic: <code>source.orders</code></p>
</li>
<li>
<p>Finally start the producer in another kafka broker shell</p>
</li>
</ul>
<div class="codehilite"><pre><span></span>/home/produceToStrimzi.sh orders
</pre></div>

<h2 id="typical-errors-in-mirror-maker-2-traces">Typical errors in Mirror Maker 2 traces</h2>
<ul>
<li>Plugin class loader for connector: 'org.apache.kafka.connect.mirror.MirrorCheckpointConnector' was not found.</li>
<li>Error while fetching metadata with correlation id 2314 : {source.heartbeats=UNKNOWN_TOPIC_OR_PARTITION}:<ul>
<li>Those messages may come from multiple reasons. One is the topic is not created. It can also being related to the fact the consumer polls on a topic that has just been created and the leader for this topic-partition is not yet available, you are in the middle of a leadership election.</li>
<li>The advertised listener may not be set or found. </li>
</ul>
</li>
<li>Exception on not being able to create Log directory: do the following: <code>export LOG_DIR=/tmp/logs</code></li>
<li>ERROR WorkerSourceTask{id=MirrorSourceConnector-0} Failed to flush, timed out while waiting for producer to flush outstanding 1 messages</li>
<li>ERROR WorkerSourceTask{id=MirrorSourceConnector-0} Failed to commit offsets (org.apache.kafka.connect.runtime.SourceTaskOffsetCommitter:114)</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../kstreams/" title="Kafka streaming notes" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Kafka streaming notes
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>